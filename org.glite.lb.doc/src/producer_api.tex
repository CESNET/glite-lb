% -*- mode: latex -*-

\section{\LB\ Logging (Producer) API}
\label{s:ProdOverview}

\subsection{C Language Binding}
The \LB\ logging API (or producer API) is used to create and deliver
events to the \LB\ server and/or proxy, depending on the function
used:

\TODO{verify ChangeACL}
\begin{table}[h]
\begin{tabularx}{\textwidth}{lX}
\bf Function & \bf Delivers to \\
\hline
\small\verb'edg_wll_LogEvent(...)' & asynchronously through
locallogger/interlogger to the \LB\ server \\
\small\verb'edg_wll_LogEventSync(...)' & synchronously through
locallogger/interlogger to the \LB\ server \\
\small\verb'edg_wll_LogEventProxy(...)' & through \LB\ proxy to the \LB\ server \\
\small\verb'edg_wll_Register*(...)' & directly to both \LB\ server and proxy \\
\small\verb'edg_wll_ChangeACL(...)' & synchronously to the \LB\ server \\
\end{tabularx}
\end{table}

These general functions take as an argument event format (which
defines the ULM string used) and variable number of arguments corresponding
to the given format. For each defined event there is predefined format
string in the form \verb'EDG_WLL_FORMAT_'\textit{EventType}, \eg\
\verb'EDG_WLL_FORMAT_UserTag', as well as three convenience functions
\verb'edg_wll_LogUserTag(...)', \verb'edg_wll_LogUserTagSync(...)',
\verb'edg_wll_LogUserTagProxy(...)'. 

For most developers (\ie\ those not developing the WMS itself) the
\verb'edg_wll_LogUserTag*(...)' and \verb'edg_wll_ChangeACL(...)' are
the only functions of interest.

\subsubsection{Call semantics}
\LB producer calls generally do not have transaction semantics, the
query following succesful logging call is not guaranteed to see
updated \LB server state. The typical call -- loging an event -- is
returned immediatelly and the success of the call means that the first
\LB infrastructure component takes over the event and queues it for
delivery. If you require transaction semantics, you have to use
synchronous \verb'edg_wll_LogEventSync(...)' call. 

The \LB proxy on the other hand provides a \emph{local view}
semantics, events logged into proxy using
\verb'edg_wll_LogEventProxy(...)' are guaranteed to by accessible by
subsequent queries \emph{on that proxy}.

Job registrations are all synchronous.

\subsubsection{Header files}

\begin{table}[h]
\begin{tabularx}{\textwidth}{>{\tt}lX}
%glite/lb/context.h & Definition of context structure and parameters. \\
glite/lb/producer.h & Prototypes for all event logging functions. \\
\end{tabularx}
\end{table}

\subsubsection{Context parameters}
The table\ref{t:pcontext} summarizes context parameters relevant to the
event logging. If  parameter is not set in the context explicitly, the
\LB\ library will search for value of corresponding environment
variable. The symbolic C names should be prepended with
\verb'EDG_WLL_PARAM_' prefix, \ie\ \verb'EDG_WLL_PARAM_HOST'.

\begin{table}[h]
\begin{tabularx}{\textwidth}{llX}
{\bf Name: Type}  & {\bf Env. variable} & {\bf Description} \\
\hline
\lstinline'HOST': \lstinline'char*' & & Hostname that appears as event origin. \\
\lstinline'SOURCE': \lstinline'edg_wll_Source' & & Event source component. \\
\lstinline'DESTINATION': \lstinline'char*' & \lstinline'GLITE_WMS_LOG_DESTINATION' & Hostname of machine running
locallogger/interlogger. \\
\lstinline'DESTINATION_PORT': \lstinline'int' &
\lstinline'GLITE_WMS_LOG_DESTINATION' Port the locallogger is
listening on. \\
\lstinline'LOG_TIMEOUT': \lstinline'struct timeval' &
\lstinline'GLITE_WMS_LOG_TIMEOUT' & Logging timeout for asynchronous
logging. \\
\lstinline'LOG_SYNC_TIMEOUT': \lstinline'struct timeval' &
\lstinline'GLITE_WMS_LOG_SYNC_TIMEOUT' & Logging timeout for
synchronous logging. \\
\lstinline'LBPROXY_STORE_SOCK': \lstinline'char*' &
\lstinline'GLITE_WMS_LBPROXY_STORE_SOCK' & \LB\ Proxy store socket
path (if logging through \LB\ Proxy) \\
\lstinline'LBPROXY_USER': \lstinline'char*' &
\lstinline'GLITE_WMS_LBPROXY_USER' & Certificate subject of the user
(if logging through \LB\ proxy). \\
\end{tabularx}
\caption{Producer specific context parameters}
\label{t:pcontext}
\end{table}
The \verb'GLITE_WMS_LOG_DESTINATION' environment variable contains
both locallogger host and port separated by colon (\ie\ ``host:port'').

\subsubsection{Return values}
The logging functions return 0 on success and one of \texttt{EINVAL,
ENOSPC, ENOMEM, ECONNREFUSED, EAGAIN} on error. If \texttt{EAGAIN} is
returned, the function should be called again to retry the delivery;
it is not guaranteed, however, that the event was not delivered by the
first call. Possibly duplicated events are discarded by the \LB\
server or proxy.

\TODO{check these}
The synchronous variants of logging functions can in addition return
\verb'EDG_WLL_ERROR_NOJOBID' or \verb'EDG_WLL_ERROR_DB_DUP_KEY'.

\subsubsection{Logging events}
\TODO{odkaz na soubor}
In this section we will give an example how to log an UserTag event to
the \LB.

First we have to include neccessary headers:
\lstinputlisting[firstline=8,lastline=10]{prod_example1.c}

Initialize context and set parameters:
\lstinputlisting[firstline=61,lastline=84]{prod_example1.c}

\TODO{proper setting of sequence codes}
\lstinputlisting[firstline=86,lastline=91]{prod_example1.c}

Log the event:
\lstinputlisting[firstline=93,lastline=107]{prod_example1.c}

The \verb'edg_wll_LogEvent()' function is defined as follows:
\begin{lstlisting}[numbers=none]
extern int edg_wll_LogEvent(
        edg_wll_Context context,
        edg_wll_EventCode event,
        char *fmt, ...);
\end{lstlisting}
If you use this function, you have to provide event code, format
string and corresponding arguments yourself. The UserTag event has
only two arguments, tag name and value, but other events require more
arguments. 

Instead of using the generic \verb'edg_wll_LogEvent()', we could also
write:
\begin{lstlisting}[firstnumber=92]
err = edg_wll_LogUserTag(ctx, name, value);
\end{lstlisting}

\subsection{Java binding}
\TODO{mirek}

