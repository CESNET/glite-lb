\section{Maintenance}

\subsection{\LB server}

This section deals with several typical but more peculiar tasks
that need more verbose description.
It is complemented with the full commands reference that is provided
as standard manual pages installed with the \LB packages.

\subsubsection{Server superusers}

Certain administrative operations (identified bellow when appropriate)
on \LB server are privileged.
When they are invoked remotely, a~special authorization is required.
By default, the server identity (X509 certificate subject) is considered
privileged.
Additional subjects can be specified in \emph{superusers file},
specified by \verb'--super-users-file' server option
(one subject per line).

The default startup script checks for existence of 
/opt/glite/etc/LB-super-users and uses it eventually.

\subsubsection{Changing index configuration}

% full-scan skodi, LB se tomu brani
Inefficient queries, yielding full scan of \LB database tables (up to millions of tuples) would degrade server performance.
Therefore \LB does not allow arbitrary queries in general
(server option \verb'--no-index' can change this behaviour).
On the contrary, a~query has to hit a~\emph{job index}, build on one or
more job attributes.
It is left up to the specific \LB server administrator to decide
which job attributes are selective enough to be indexed and allow queries
(\eg for many-users communities job owner can be a~sufficient criterion;
for others, where only a~few users submit thousands of jobs, it is not).

% indexy  -- implementace jako extra sloupce => zmeny offline, konfigurace
% olizovana z DB
Technically, job indices are implemented via dedicated columns
in a~database table.
These columns and their indices are scanned by the \LB server on startup,
therefore there is no specific configuration file.
Changing the index configuration is rather heavyweight operation
(depending on the number of jobs in the database), it performs
updates of all tuples in general, and it should be done when the server is not
running.

% utilitka bkindex -- pouziti
Indices are manipulated with a~standalone utility \verb'glite-lb-bkindex'
(see its man page for complete usage reference).
A~general sequence of changing the indices is:
\begin{enumerate}
\item stop the running server
\item retrieve current index configuration
\begin{quote}
\verb'glite-lb-bkindex -d >index_file'
\end{quote}
\item edit \verb'index_file' appropriately
\item re-index the database (it may take long time)
\begin{quote}
\verb'glite-lb-bkindex -r -v index_file'
\end{quote}
\verb'-r' stands for ``really do it'', \verb'-v' is ``be verbose''
\item start the server again
\end{enumerate}

% format vstupniho souboru
The index description file follows the classad format, having the following grammar:
\begin{quote}
\emph{IndexFile} ::= [ JobIndices = \{ \emph{IndexList} \} ] \\
\emph{IndexList} ::= \emph{IndexDef} $|$ \emph{IndexDef}, \emph{IndexList} \\
\emph{IndexDef} ::= \emph{IndexColumn} $|$ \emph{ComplexIndex} \\
\emph{IndexColumn} ::= [ type = "\emph{IndexType}"; name = "\emph{IndexName}" ]\\
\emph{ComplexIndex} ::= \{ \emph{ColumnList} \} \\
\emph{ColumnList} ::= \emph{IndexColumn} $|$ \emph{IndexColumn}, \emph{ColumnList}
\end{quote}

where eligible \emph{IndexType}, \emph{IndexName} combinations are given
in Tab.~\ref{t:indexcols}.
A~template index configuration, containing indices on the most frequently
used attributes, can be found in /opt/glite/etc/glite-lb-index.conf.template.


\begin{table}
\begin{center}
\begin{tabularx}{.9\hsize}{|l|l|X|}
\hline
\emph{IndexType} & \emph{IndexName} & description \\
\hline
system & owner & job owner \\
 & destination & where the job is heading to (computing element name) \\
 & location & where is the job being processed \\
 & network\_server & endpoint of WMS \\
 & stateEnterTime & time when current status was entered \\
 & lastUpdateTime & last time when the job status was updated \\
\hline
time & \emph{state name} & when the job entered given state (Waiting, Ready, \dots) \\
\hline
user & \emph{arbitrary} & arbitrary user tag \\
\hline
\end{tabularx}
\end{center}
\caption{Available index column types and names}
\label{t:indexcols}
\end{table}

% super user muze vsechno

\subsubsection{Multiple server instances}

% lze to, i nad jednou databazi, zadna automaticka podpora

Specific conditions (\eg debugging, different authorization setup, \dots)
may require running multiple \LB server instances
on the same machine.
Such setup is available, however, there is no specific support in automated
configuration, the additional non-default server instances must be run manually.

The other server instance must use different ports (changed with \verb'-p'
and \verb'-w' options), as well as use different pid file (\verb'-i' option).

The servers may or may not share the database (non-default is specified
with  \verb'-m')%
\footnote{Even when sharing the database, the servers are still 
partially isolated from
one another, \eg a~job \url{https://my.machine:9000/xyz} cannot be queried 
as \url{https://my.machine:8000/xyz}.
However, due to implementation internals, the second job cannot be registered.}.

\subsubsection{Backup dumps}

(This functionality should not be confused with per-job dumps, Sect.~\ref{inst:purge} and \ref{run:purge}.)

Besides setting up \LB server database on a~reliable storage or
backing it up directly (Sect.~\ref{inst:backup})
\LB server supports backing up only incremental changes in the data.
Advantages of this approach are lower volume of data to be backed up,
and possibility to load them to another instance (\eg for heavyweight
queries which should not disturb normal operation), disadvantage is
a~more complex and more fragile setup. 

Using an external utility \verb'glite-lb-dump' (typical invocation is with
a~single option \verb'-m' \emph{my.server.name:port}, see man page for
details) the server is triggered to dump events, which arrived in
a~specified time interval, into a~text file. (Default interval is from last
dump till the current time.)

\verb'glite-lb-dump' is a~standalone client program, however, 
the events are stored at server side (\ie not transferred to the client,
due to performance reasons),
in a~uniquely named text
file prefixed with the value of \verb'-D' server option. This kind of dump
contains events according to their arrival time, regardless of jobs they belong
to.

It is sufficient to run the dump regularly (from a~cron job), with a~frequency
matching an acceptable risk of loosing data (several hours typically), and back
up the resulting dump files. 

In the event of server crash, its database should be recreated empty,
and the server started up.
Then the dump files can be loaded back with complementary
\verb'glite-lb-load' utility.

Server superuser privileges (X509 credentials) are required to run \verb'glite-lb-dump' and \verb'glite-lb-load'.
Dumping the events does not interfere with normal server operation.

This backup strategy can interfere with too aggressive setting of old
data purging (Sect.~\ref{run:purge}), 
If the purging grace period is shorter than the dump interval,
events may get purged before they are captured by the backup dump.
However, this interference is unlikely (reasonable purge grace period
is several times longer than dump period),
and it is not fatal in general (data were purged on purpose either).

\subsubsection{Purging and processing old data}
\label{run:purge}

Primary purpose of the LB purge operation  is removal of aged data from LB database. This is necessary in
production in order to prevent ever-increasing database and sustain reasonable
performance of the server. Therefore the purge should be invoked periodically.

The purge operation has additional important ``side effect'' -- dumping the
purged data into a plain text file. These dumps can be archived ``as is'' or
uploaded to Job Provenance. 

\paragraph{Purge setup}

The purge operation itself is performed by a~running \LB server
(there is no need to shut it down, then).
However, it is triggered with \verb'glite-lb-purge' client command
(complete usage reference is given in its man page).
A~typical invocation specifies \LB server to purge (\verb'-m' option),
and purge timeouts (grace periods) for several job states -- options
\verb'-a' (aborted), \verb'-n' (canceled), \verb'-c' (cleared), and
\verb'-o' (other).
A~job falling in one of the four categories is purged when it has not been
touched (\ie an event arrived) for time longer than the specified category
timeout.
Suggested values are several days for aborted and canceled jobs,
and one day for cleared jobs, however, the values may strongly vary
with \LB server policy.

Optionally, \verb'-s' purge command option instructs the server to
dump the purged data into a~file at the server side.
It's location (prefix) is given by \verb'-S' server option,
the purge command reports a~specific file name on its output.

It is recommended (and the default YAIM setup does so, via
the \verb'glite-lb-export.sh' wrapper) to run the purge
command periodically from cron.

Server superuser privileges (X509 credentials) are required to run \verb'glite-lb-purge'.

If the server database has already grown huge, the purge operation can take
rather long and hit the \LB server operation timeout. At client side, \ie the
glite-lb-purge command, it can be increased by setting GLITE\_WMS\_QUERY\_TIMEOUT
environment variable.

Sometimes hardcoded server-side timeout can be still reached; in this case the
server fails to return a correct response but the purge is done anyway. 

\textbf{\LBnew only}: option \verb'-x' allows purging \LB proxy database too.

\paragraph{Emergency purge}

When regular purge was not invoked for some time, it may happen that 
the database grows huge and the regular (on-line) purge fails.
In order to work around such situation we provide an off-line emergency
purge script \verb'glite-lb-bkpurge-offline.sh'

The script accepts the same \verb'-acno' options, and adds \verb'-d' for ``done'' jobs. 
Via \verb'-p' also \LB proxy database can be purged (all \LB versions).

On startup, a~warning message is printed and interactive confirmation
requested.
Re-check that \LB server (proxy) is not running, and carry on only when you
know what you are doing.

\paragraph{Post-mortem statistics}

\TODO{honik}

\paragraph{Export to Job Provenance}

An important, though currently optional, processing of \LB dumps
is their upload to the Job Provenance service for permanent preservation
of the data.


When enabled (via configuration environment variables, see bellow), 
the export is done in two steps:
\begin{itemize}
\item \verb'glite-lb-export.sh' wrapper script, after calling \verb'glite-lb-purge', breaks up the resulting dump file on a~per-job basis.
The individual job dump files are stored in a~dedicated spool directory.
\item \verb'glite-jp-importer' daemon (installed optionally in glite-jp-client.rpm) checks the spool directory periodically,
and tries to upload the files into JP.
\end{itemize}

Details, including the configuration variables, are covered at the following
wiki page:
\url{http://egee.cesnet.cz/mediawiki/index.php/LB_purge_and_export_to_JP}.

\subsubsection{On-line monitoring and statistics}

CE Rank

DB mon (a mon)

histogramy :-)

\subsection{\LB proxy}

Purge zamrzlych jobu (overit v kodu, na ktere verzi to mame(installed optionally in glite-jp-client.rpm) )


\subsection{\LB logger}

Karantena (od ktere verze to mame?)

Cistky pri zaseknuti, nesmyslna jobid apod.

\subsection{Used resources}

Adresare, porty, ...
