\section{Maintenance}

\subsection{\LB server}

This section deals with several typical but more peculiar tasks
that need more verbose description.
It is complemented with the full commands reference that is provided
as standard manual pages installed with the \LB packages.

\subsubsection{Changing index configuration}

% full-scan skodi, LB se tomu brani
Inefficient queries, yielding full scan of \LB database tables (up to millions of tuples) would degrade server performance.
Therefore \LB does not allow arbitrary queries in general
(server option \verb'--no-index' can change this behaviour).
On the contrary, a~query has to hit a~\emph{job index}, build on one or
more job attributes.
It is left up to the specific \LB server administrator to decide
which job attributes are selective enough to be indexed and allow queries
(\eg for many-users communities job owner can be a~sufficient criterion;
for others, where only a~few users submit thousands of jobs, it is not).

% indexy  -- implementace jako extra sloupce => zmeny offline, konfigurace
% olizovana z DB
Technically, job indices are implemented via dedicated columns
in a~database table.
These columns and their indices are scanned by the \LB server on startup,
therefore there is no specific configuration file.
Changing the index configuration is rather heavyweight operation
(depending on the number of jobs in the database), it performs
updates of all tuples in general, and it should be done when the server is not
running.

% utilitka bkindex -- pouziti
Indices are manipulated with a~standalone utility \verb'glite-lb-bkindex'
(see its man page for complete usage reference).
A~general sequence of changing the indices is:
\begin{enumerate}
\item stop the running server
\item retrieve current index configuration
\begin{quote}
\verb'glite-lb-bkindex -d >index_file'
\end{quote}
\item edit \verb'index_file' appropriately
\item re-index the database (it may take long time)
\begin{quote}
\verb'glite-lb-bkindex -r -v index_file'
\end{quote}
\verb'-r' stands for ``really do it'', \verb'-v' is ``be verbose''
\item start the server again
\end{enumerate}

% format vstupniho souboru
The index description file follows the classad format, having the following grammar:
\begin{quote}
\emph{IndexFile} ::= [ JobIndices = \{ \emph{IndexList} \} ] \\
\emph{IndexList} ::= \emph{IndexDef} $|$ \emph{IndexDef}, \emph{IndexList} \\
\emph{IndexDef} ::= \emph{IndexColumn} $|$ \emph{ComplexIndex} \\
\emph{IndexColumn} ::= [ type = "\emph{IndexType}"; name = "\emph{IndexName}" ]\\
\emph{ComplexIndex} ::= \{ \emph{ColumnList} \} \\
\emph{ColumnList} ::= \emph{IndexColumn} $|$ \emph{IndexColumn}, \emph{ColumnList}
\end{quote}

where eligible \emph{IndexType}, \emph{IndexName} combinations are given
in Tab.~\ref{t:indexcols}.
A~template index configuration, containing indices on the most frequently
used attributes, can be found in /opt/glite/etc/glite-lb-index.conf.template.


\begin{table}
\begin{center}
\begin{tabularx}{.9\hsize}{|l|l|X|}
\hline
\emph{IndexType} & \emph{IndexName} & description \\
\hline
system & owner & job owner \\
 & destination & where the job is heading to (computing element name) \\
 & location & where is the job being processed \\
 & network\_server & endpoint of WMS \\
 & stateEnterTime & time when current status was entered \\
 & lastUpdateTime & last time when the job status was updated \\
\hline
time & \emph{state name} & when the job entered given state (Waiting, Ready, \dots) \\
\hline
user & \emph{arbitrary} & arbitrary user tag \\
\hline
\end{tabularx}
\end{center}
\caption{Available index column types and names}
\label{t:indexcols}
\end{table}

% super user muze vsechno

\subsubsection{Multiple server instances}

% lze to, i nad jednou databazi, zadna automaticka podpora

Specific conditions (\eg debugging, different authorization setup, \dots)
may require running multiple \LB server instances
on the same machine.
Such setup is available, however, there is no specific support in automated
configuration, the additional non-default server instances must be run manually.

The other server instance must use different ports (changed with \verb'-p'
and \verb'-w' options), as well as use different pid file (\verb'-i' option).

The servers may or may not share the database (non-default is specified
with  \verb'-m')%
\footnote{Even when sharing the database, the servers are still 
partially isolated from
one another, \eg a~job \url{https://my.machine:9000/xyz} cannot be queried 
as \url{https://my.machine:8000/xyz}.
However, due to implementation internals, the second job cannot be registered.}.

\subsubsection{Backup dumps}

(This functionality should not be confused with per-job dumps, Sect.~\ref{inst:purge} and \ref{run:purge}.)

Besides setting up \LB server database on a~reliable storage or
backing it up directly (Sect.~\ref{inst:backup})
\LB server supports backing up only incremental changes in the data.
Advantages of this approach are lower volume of data to be backed up,
and possibility to load them to another instance (\eg for heavyweight
queries which should not disturb normal operation), disadvantage is
a~more complex and more fragile setup. 

Using an external utility \verb'glite-lb-dump' (typical invocation is with
a~single option \verb'-m' \emph{my.server.name:port}, see man page for
details) the server is instructed to dump events, which arrived in
a~specified time interval, into a~text file.  Default interval is from last
dump till the current time.  The events are stored in a~uniquely named text
file prefixed with the value of \verb'-D' server option.  This kind of dump
contains events according to their arrival time, regardless of jobs they belong
to.

It is sufficient to run the dump regularly, with a~frequency matching
an acceptable risk of loosing data (several hours typically), and back up the
resulting dump files.  In the event of server crash, the files can be loaded
back into a~restored empty server with complementary \verb'glite-lb-load'
utility.

Server superuser privileges (X509 credentials) are required to run \verb'glite-lb-dump' and \verb'glite-lb-load'.

This backup strategy can interfere with too aggressive setting of old
data purging (Sect.~\ref{run:purge}), 
If the purging grace period is shorter than the dump interval,
events may get purged before they are captured by the backup dump.
However, this interference is unlikely (reasonable purge grace period
is several times longer than dump period),
and it is not fatal in general (data were purged on purpose either).

\subsubsection{Purging and processing old data}
\label{run:purge}

\TODO{salvet}

\paragraph{Post-mortem statistics}

\paragraph{Export to Job Provenance}

\subsubsection{On-line monitoring and statistics}

CE Rank

DB mon (a mon)

histogramy :-)

\subsection{\LB proxy}

Purge zamrzlych jobu (overit v kodu, na ktere verzi to mame)

\subsection{\LB logger}

Karantena (od ktere verze to mame?)

Cistky pri zaseknuti, nesmyslna jobid apod.

\subsection{Used resources}

Adresare, porty, ...
