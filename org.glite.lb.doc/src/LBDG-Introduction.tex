% -*- mode: latex -*-

\section{Introduction}

This document is intented to guide the reader through basic steps
of writing, compiling and running programs communicating with the \LB
service using the \LB library. It is not intended as a complete API
reference; for this, the reader is referred to the C or C++ header
files, which are thoroughly documented using the doxygen--style
comments. 

The \LB API can be divided by functionality into two independent
parts:
\begin{itemize}
\item \textit{\LB Producer API} (section \ref{s:ProdOverview}) is used
to create and send events to the \LB server (proxy),
\item \textit{\LB Consumer API} (section \ref{s:ConsOverview}) and \textit{\LB
Notification API} (section \ref{s:NotifOverview}) are used to obtain
information from the  \LB server (proxy).
\end{itemize}
These two parts (and in fact the whole \LB service implementation)
share a number of common concepts, design principles, data types and
functions which we will describe first. Most of common data types and
functions are separated in its own SW module called
\verb'org.glite.lb.common' and are described in section~\ref{s:common}

\marginpar{Recommended reading}%
Before you start reading this guide, it is recommended to accomodate
yourself with the \LB architecture described in the first part of the
\LB user's guide (\cite{lbug}).


\subsection{Language Bindings}
The \LB library itself is developed in C language, the C API covers
all the \LB services. There are bindings for other languages (C++,
Java) as well as web--service based interface, but these cover only
subsets of \LB functionality and internally they use the C API
themselves (in the C++ case the C API also exported).

We describe the C API first and then the differences between C and the
other languages, as the C constructs often reflect directly.

\subsection{General Guidelines}

\TODO{kde se vzalo edg}

\marginpar{Naming conventions}%
All names exported by the \LB library (function names, symbolic
constants) are prefixed to avoid name clashes. The prefix is
\verb'edg_wll_' for function names and \verb'EDG_WLL_' for
symbolic constants. In C++ the namespace \verb'glite::lb' is used
instead.

\marginpar{Symbolic constants}%
Symbolic constants (\ie enumerated types) are used at various places in the \LB
API. There is a user--friendly string representation of each
constant and for each enumerated type there are two functions that
convert strings to enum values and vice versa. Example is given in
section~\ref{s:edg_wll_Event}

\marginpar{Input and output arguments}%
All input arguments in \LB API are designated \verb'const' (for simple
types) or have \verb'const' in type name (for structures).

If pointers are passed in output of function call (either as a return
value, output argument or part of structure), the corresponding
objects are \emph{always} allocated dynamically and have to be freed
when not used anymore. Structures defined in \LB API can be
deallocated by calling convenience
\verb'edg_wll_Free'\textit{Type}\verb'()' functions. {\it This
deallocates members of the structure, but not the structure itself. It
has to be \verb'free()''d explicitly.}

\marginpar{Opaque and transparent types}%
Types used in \LB API are either opaque or transparent. \textit{Opaque
types} are considered internal to the library, their structure is not
exposed to users and is subject to change without notice. The only way
to modify opaque objects is to use API calls. Example of opaque type
is \verb'edg_wll_Context'.

Structure of \textit{transparent types} is completely visible to
user, is well documented and no incompatible changes will be done
without notice. Example of transparent type is
\verb'edg_wll_Event'.

\marginpar{Return values}%
The return type of most of the API functions is \verb'int'.
Unless specified otherwise, zero return value means success, non-zero
failure. Standard error codes from \verb'errno.h' are used as
much as possible. In a few cases the error can not be intuitively
mapped and \LB specific error value greater than
\verb'EDG_WLL_ERROR_BASE' is returned.

Few API function return \verb'char *'. In such a~case
\verb'NULL' indicates an error, non-null value means success.

\subsection{Context and Parameter Settings}
\label{s:context}

The \LB library does not maintain internal state (apart of network connections, see \ref{s:pool}), all the API
functions refer to a~\emph{context} argument instead.
Context object preserves state information among the various API
calls, the state including \LB library parameters (\eg security
context, server addresses, timeouts), reference to open connections
(connection pool), error state etc.

The API caller can create many context objects which are guaranteed
to be independent on one another. In this way thread--safety of the
library is achieved as long as the context is not used by more threads
at the same time. One thread may use more than one context, though.

Upon context initialization, all the parameters are assigned default
values. If not set explicitly, many of the parameters take their
value from environment variables. If the corresponding environment
variable is set, the parameter is initialized to its value instead of
the default. Note that a~few parameters cannot be assigned default
value; consequently setting them either in environment or with an
explicit API call is mandatory before using the appropriate part of
the API.

The context also stores details on errors of the recent API call.

For use with the \emph{producer} calls (see section~\ref{s:producer})
the context has to be assigned a~single \jobid (with the
\verb'edg_wll_SetLoggingJob()' call), and keeps track of an event
\emph{sequence code} for the job (see~\cite{lbug}, detailed
description in~\cite{lbarch}).

The context object and its API functions are described more thoroughly
in section~\ref{s:edg_wll_context}

\subsection{Connection Pool}
\label{s:pool}
The \LB library maintains pool of client--server connections to
improve performance (creating SSL connection is heavy--weight
operation). The connections are transparently shared and reused by all
contexts/threads to eliminate the overhead of secure channel
establishment. This behaviour is completely hidden by the library.

\section{\LB Common Components}
\label{s:common}

\subsection{C Language Binding}

\subsubsection{Header Files}

Header files for the common structures and functions are summarized in
table~\ref{t:cheaders}. If you use the producer and/or consumer API
described further in this document, you do not have to include them
explicitly.

\begin{table}[h]
\begin{tabularx}{\textwidth}{>{\tt}lX}
glite/jobid/cjobid.h & Definition of job identifier. \\
glite/lb/context.h & Definition of context structure and parameters. \\
glite/lb/events.h & \LB event data structure.\\
glite/lb/jobstat.h & Job status structure returned by consumer API.\\
\end{tabularx}
\caption{Header files for common structures}
\label{t:cheaders}
\end{table}

\subsubsection{Context} 
\label{s:edg_wll_context}
\marginpar{Context initialization}%
Opaque data structure representing \LB API context (see
section~\ref{s:context}) is named \verb'edg_wll_Context'.
The context must be initialized before the first \LB API call:
\begin{lstlisting}
#include <glite/lb/context.h>

edg_wll_Context ctx;
edg_wll_InitContext(&ctx);
\end{lstlisting}

\marginpar{Parameter setting}%
The context parameters can be set explicitly by calling
\begin{lstlisting}
int edg_wll_SetParam(edg_wll_Context *, edg_wll_ContextParam, ...);
\end{lstlisting}
function. The second argument is symbolic name of the context
parameter; parameters specific for producer and consumer API are
described in respective API sections, the common parameters are:

\begin{table}[h]
\begin{tabularx}{\textwidth}{llX}
{\bf C name} & {\bf Env. variable} & {\bf Description} \\
\hline
\lstinline'EDG_WLL_PARAM_X509_KEY' & \lstinline'X509_USER_KEY' & Key file to use for
authentication. \\
\lstinline'EDG_WLL_PARAM_X509_CERT' & \lstinline'X509_USER_CERT' & Certificate file to use
for authentication. \\
\lstinline'EDG_WLL_PARAM_CONNPOOL_SIZE' & & Maximum number
of open connections maintained by the library. \\
\end{tabularx}
\end{table}

The third argument is parameter value, which can be of type
\verb'int', \verb'char *' or \verb'struct timeval *'. 
If the parameter value is set to \verb'NULL' (or 0), the 
parameter is reset to the default value.

If you want to obtain current value of some context parameter, call
\begin{lstlisting}
int edg_wll_GetParam(edg_wll_Context, edg_wll_ContextParam, ...);
\end{lstlisting}
function:
\begin{lstlisting}
char *cert_file;

edg_wll_GetParam(ctx, EDG_WLL_PARAM_X509_CERT, &cert_file);
printf("Certificate used: %s\n", cert_file);
free(cert_file);
\end{lstlisting}
The third argument points at variable with type corresponding to the
requested parameter. Do not forget to free the result.

\TODO{MÃ¡me odkaz kde jsou popsany defaulty a vazby na promenne environmentu?}

\marginpar{Obtaining error details}%
When \LB API call returns error, additional details can be obtained
from the context:
\begin{lstlisting}
char    *err_text,*err_desc;
        
edg_wll_Error(ctx, &err_text, &err_desc);
fprintf(stderr, "LB library error: %s (%s)\n", err_text, err_desc);
free(err_text);
free(err_desc);
\end{lstlisting}

\marginpar{Context deallocation}%
If the context is needed no more, deallocate it:
\begin{lstlisting}
edg_wll_FreeContext(ctx);
\end{lstlisting}

For more information see file \verb'glite/lb/context.h'

\subsubsection{JobId} 
The primary entity of \LB is a job, identified by JobId -- a unique
identifier of the job (see also \cite{lbug}). The type representing
the JobId is opaque \verb'glite_jobid_t'. The JobId is in fact
just URL with \verb'https' protocol, path component being unique string
with no further structure and host and port designating the \LB server
holding the job information. The JobId can be
\begin{itemize}
\item created new for given \LB server (the unique part will be
generated by the \LB library):
\begin{lstlisting}
glite_jobid_t jobid;
int ret; 
if(ret = glite_jobid_create("some.host", 0, &jobid)) {
	fprintf(stderr, "error creating jobid: %s\n", strerror(ret));
}
\end{lstlisting}
\item parsed from string (\eg when given as an program argument or
read from file):
\begin{lstlisting}[firstnumber=3]
if(ret = glite_jobid_parse("https://some.host:9000/OirOgeWh_F9sfMZjnIPYhQ", &jobid)) {
\end{lstlisting}
\item or obtained as part of \LB server query result.
\end{itemize}
In either case the jobid must be freed when no longer in use:
\begin{lstlisting}
glite_jobid_free(jobid);
\end{lstlisting}

For more information see file \verb'glite/jobid/cjobid.h'

\marginpar{\textbf{\LB 1.x}}%
{\it In the older \LB versions (1.x) the
structure was named \verb'edg_wlc_JobId' and the functions had prefix
\verb'edg_wlc_JobId'. Exact description can be found in the
header file \verb'glite/wmsutils/cjobid.h'}


\subsubsection{Event}
\label{s:edg_wll_Event}
The transparent data structure \verb'edg_wll_Event' represents \LB
event, atomic data unit received and processed by \LB. It is a set of
attributes (\ie key--value pairs) with predefined structure -- there
are common attributes and each defined event type allows for specific
set of additional attributes.  The most important common event
attributes are listed in table~\ref{t:cevent}, 

\begin{table}[h]
\begin{tabularx}{\textwidth}{llX}
\bf Attribute name & \bf Attribute type & \bf Description \\
\hline
\verb'type' & \verb'edg_wll_EventCode' & Event type. Values are
symbolic constants \eg \verb'EDG_WLL_EVENT_DONE' \\ 
\verb'jobId' & \verb'glite_jobid_t' & Jobid of the job the event
belongs to. \\
\verb'user' & \verb'char*' & Identity (certificate subject) of the
event sender. \\
\verb'host' & \verb'char*' & Hostname of the machine the event was
sent from. \\
\verb'source' & \verb'edg_wll_Source' & Designation of the WMS component
the event was sent from, \eg \verb'EDG_WLL_SOURCE_USER_INTERFACE' \\
\verb'timestamp' & \verb'struct timeval' & Time when the event was
generated. \\
\verb'seqcode' & \verb'char*' & Sequence code assigned to the event. \\
\end{tabularx}
\caption{Common event attributes}
\label{t:cevent}
\end{table}

The \verb'edg_wll_Event' is returned by consumer \LB
API job event related calls. The only important operation defined on 
\verb'edg_wll_Event' itself is
\begin{lstlisting}
edg_wll_FreeEvent(edg_wll_Event *event) 
\end{lstlisting}
to free the event structure.  

\marginpar{List of event types}%
The event structure makes use of enumerated types extensively,
starting with the \verb'type' atribute. The following example
demonstrates how to convert enumerated values into more
user--friendly strings; it will print out the event names known to the
\LB library:
\begin{lstlisting}
edg_wll_EventCode ev_type;

for(ev_type = 1; ev_type < EDG_WLL_EVENT__LAST; ev_type++) {
	char *ev_string = edg_wll_EventToString(ev_type);
	if(ev_string) {
	   /* there may be holes */
           printf("%s\n", ev_string);
	   free(ev_string);
        }
}
\end{lstlisting}

For more information see file \verb'include/glite/lb/events.h'

\subsubsection{JobStatus}
The transparent data type \verb'edg_wll_JobStat' represents status of
a job as computed by the \LB from received events.  Much like the
\verb'edg_wll_Event' structure it can be viewed as a set of
attributes, where some attributes are common and some specific
for a given job state (but unlike the \verb'edg_wll_Event' it is not
implemented as union of structs but rather as one big struct). Most
important common attributes are summarized in table~\ref{t:cstatus}.

\TODO{Is somewhere documented what attributes are filled in for given
job type and status?}

\begin{table}[h]
\begin{tabularx}{\linewidth}{llX}
\bf Attribute name & \bf Attribute type & \bf Description \\
\hline
\verb'jobId' & \verb'glite_jobid_t' & Job identifier of this job. \\
\verb'state' & \verb'edg_wll_JobStatCode' & Numeric code of the status, \eg
\verb'EDG_WLL_JOB_SUBMITTED'. \\
\verb'type' & \verb'enum edg_wll_StatJobtype' & Type of the job, \eg
\verb'EDG_WLL_JOB_SIMPLE'. \\
\verb'children' & \verb'char**' & List of subjob \jobid's \\
\verb'owner' & \verb'char*' & Owner (certificate subject) of the
job. \\
\end{tabularx}
\caption{Common job status attributes}
\end{table}

Job status structure is returned by the \LB consumer API job status
queries. When no longer used, it has to be freed by calling
\begin{lstlisting}
void edg_wll_FreeStatus(edg_wll_JobStat *);
\end{lstlisting}

The following example prints out the states of jobs given in the input
list; the job states are printed together with their subjobs on the
same input list:
\lstinputlisting[firstline=12,numbers=left]{util.c}

For more information see file \verb'include/glite/lb/jobstat.h'

\subsubsection{Building Programs}
The easiest way to build programs using the \LB library is to use
GNU's libtool to take care of all the dependencies:
\begin{verbatim}
flavour=gcc32dbg
libtool --mode=compile gcc -c example1.c util.c \
        -I$GLITE_LOCATION/include -D_GNU_SOURCE
libtool --mode=link gcc -o example1 example1.o util.o \
        -L$GLITE_LOCATION/lib -lglite_lb_client_$flavour
\end{verbatim}
The library comes in different flavours (with/without debugging
symbols, with/withou thread support) which in turn depend on the
correct Globus library flavours.

\TODO{Library dependencies - which rpms are needed?}

\subsection{C++ Language Binding}
\marginpar{Exceptions}%

\marginpar{Reference counting}%

\subsubsection{Header Files}
\subsubsection{Event}
\subsubsection{Building Programs}
