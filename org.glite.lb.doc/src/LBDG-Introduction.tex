% -*- mode: latex -*-

\section{Introduction}

\input{versions}

This document is intented to guide the reader through basic steps
of writing, compiling and running programs communicating with the \LB
service using the \LB library. It is not intended as a complete API
reference; for this, the reader is referred to the C or C++ header
files, which are thoroughly documented using the doxygen--style
comments. 

The \LB API can be divided by functionality into two independent
parts:
\begin{itemize}
\item \textit{\LB Producer API} (section \ref{s:ProdOverview}) is used
to create and send events to the \LB server (proxy),
\item \textit{\LB Consumer API} (section \ref{s:ConsOverview}) and \textit{\LB
Notification API} (section \ref{s:NotifOverview}) are used to obtain
information from the  \LB server (proxy).
\end{itemize}
These two parts (and in fact the whole \LB service implementation)
share a number of common concepts, design principles, data types and
functions which we will describe first. Most of common data types and
functions are separated in its own SW module called
\texttt{org.glite.lb.common} and are described in section~\ref{s:common}

\marginpar{Recommended reading}
Before you start reading this guide, it is recommended to accomodate
yourself with the \LB architecture described in the first part of the
\LB user's guide (\cite{lbug}).


\subsection{General Guidelines}

\marginpar{Naming conventions}
All names exported by the \LB library (function names, symbolic
constants) are prefixed to avoid name clashes. The prefix is
\lstinline'edg_wll_' for function names and \lstinline'EDG_WLL_' for
symbolic constants.

\marginpar{Input and output arguments}
All input arguments in \LB API are designated \lstinline'const' (for simple
types) or have \texttt{const} in type name (for structures).

If pointers are passed in output of function call (either as a return
value, output argument or part of structure), the corresponding
objects are \emph{always} allocated dynamically and have to be freed
when not used anymore. 

\marginpar{Opaque and transparent types}
Types used in \LB API are either opaque or transparent. \textit{Opaque
types} are considered internal to the library, their structure is not
exposed to users and is subject to change without notice. The only way
to modify opaque objects is to use API calls. Example of opaque type
is \lstinline'edg_wll_Context'.

Structure of \textit{transparent types} is completely visible to
user, is well documented and no incompatible changes will be done
without notice. Example of transparent type is
\lstinline'edg_wll_Event'.

\marginpar{Return values}
The return type of most of the API functions is \lstinline'int'.
Unless specified otherwise, zero return value means success, non-zero
failure. Standard error codes from \lstinline'<errno.h>' are used as
much as possible. In a few cases the error can not be intuitively
mapped and \LB specific error value greater than
\lstinline'EDG_WLL_ERROR_BASE' is returned.

\TODO{mozna by stalo za to zminit f-ce edg\_wll\_*Error*}

Few API function return \lstinline'char *'. In such a~case
\lstinline'NULL' indicates an error, non-null value means success.

\subsection{Context and Parameter Settings}
\label{s:context}

The \LB library does not maintain internal state, all the API
functions refer to a~\emph{context} argument instead.
Context object preserves state information among the various API
calls, the state including \LB library parameters (\eg security
context, server addresses, timeouts), reference to open connections
(connection pool), error state etc.

The API caller can create many context objects which are guaranteed
to be independent on one another. In this way thread--safety of the
library is achieved as long as the context is not used by more threads
at the same time. One thread may use more than one context, though.

Upon context initialization, all the parameters are assigned default
values. If not set explicitely, many of the parameters take their
value from environment variables. If the corresponding environment
variable is set, the parameter is initialized to its value instead of
the default. Note that a~few parameters cannot be assigned default
value; consequently setting them either in environment or with an
explicit API call is mandatory before using the appropriate part of
the API.

The context also stores details on errors of the recent API call.

For use with the \emph{producer} calls (see section~\ref{s:producer})
the context has to be assigned a~single \jobid (with the
\lstinline'edg_wll_SetLoggingJob' call), and keeps track of an event
\emph{sequence code} for the job (see~\cite{lbug}, detailed
description in~\cite{lbarch}).

The context object and its API functions are described more thoroughly
in section~\ref{s:edg_wll_context}.

\subsection{Connection pool}
The \LB library maintains pool of client--server connections to
improve performance (creating SSL connection is heavy--weight
operation). The connections are transparently shared and reused by all
contexts/threads to eliminate the overhead of secure channel
establishment. This behaviour is completely hidden by the library.

\section{\LB Common Components}
\label{s:common}

\subsection{Header Files}

Header files for the structures and functions are summarized in the
table~\ref{t:cheaders} If you use the producer and/or consumer API
described further in this document, you do not have to include them
explicitly.

\begin{table}[h]
\label{t:cheaders}
\begin{tabularx}{\textwidth}{>{\tt}lX}
glite/jobid/cjobid.h & Definition of job identifier. \\
glite/lb/context.h & Definition of context structure and parameters. \\
glite/lb/events.h & \LB event data structure.\\
glite/lb/jobstat.h & Job status structure returned by consumer API.\\
\end{tabularx}
\caption{Header files for common structures}
\end{table}

\subsection{Context} 
\label{s:edg_wll_context}
\marginpar{Context initialization}
Opaque data structure representing \LB API context (see
section~\ref{s:context}) is named \lstinline'edg_wll_Context'.
The context must be initialized before the first \LB API call:
\begin{lstlisting}
#include <glite/lb/context.h>

edg_wll_Context ctx;
edg_wll_InitContext(&ctx);
\end{lstlisting}

\marginpar{Parameter setting}
The context parameters can be set explicitly by calling
\lstinline'edg_wll_SetParam(edg_wll_Context *, edg_wll_ContextParam, ...)' 
function. The second argument is symbolic name of the context
parameter; parameters specific for producer and consumer API are
described in respective API sections, the common parameters are:

\begin{table}[h]
\begin{tabularx}{\textwidth}{llX}
{\bf C name} & {\bf Env. variable} & {\bf Description} \\
\hline
\lstinline'EDG_WLL_PARAM_X509_KEY' & \lstinline'X509_USER_KEY' & Key file to use for
authentication. \\
\lstinline'EDG_WLL_PARAM_X509_CERT' & \lstinline'X509_USER_CERT' & Certificate file to use
for authentication. \\
\lstinline'EDG_WLL_PARAM_CONNPOOL_SIZE' & & Maximum number
of open connections maintained by the library. \\
\end{tabularx}
\end{table}

The third argument is parameter value, which can be of type
\lstinline'int', \lstinline'char *' or \lstinline'struct timeval *'. 
If the parameter value is set to \lstinline'NULL' (or 0), the 
parameter is reset to the default value.

If you want to obtain current value of some context parameter, call
\lstinline'edg_wll_GetParam(edg_wll_Context, edg_wll_ContextParam, ...)' function:
\begin{lstlisting}
char *cert_file;

edg_wll_GetParam(ctx, EDG_WLL_PARAM_X509_CERT, &cert_file);
printf("Certificate used: %s\n", cert_file);
free(cert_file);
\end{lstlisting}
The third argument points at variable with type corresponding to the
requested parameter. Do not forget to free the result.

\TODO{MÃ¡me odkaz kde jsou popsany defaulty a vazby na promenne environmentu?}

\marginpar{Obtaining error details}
When \LB API call returns error, additional details can be obtained
from the context:
\begin{lstlisting}
char    *err_text,*err_desc;
        
edg_wll_Error(ctx, &err_text, &err_desc);
fprintf(stderr, "LB library error: %s (%s)\n", err_text, err_desc);
free(err_text);
free(err_desc);
\end{lstlisting}

\marginpar{Context deallocation}
If the context is needed no more, deallocate it:
\begin{lstlisting}
edg_wll_FreeContext(ctx);
\end{lstlisting}

For more information see file \texttt{glite/lb/context.h}

\subsection{Job Identification} 
The primary entity of \LB is a job, identified by JobId -- a unique
identifier of the job (see also \cite{lbug}). The type representing
the JobId is opaque, it's contents is hidden to the API users and
should be manipulated with the access methods only.

The JobId representing data structure name and location
changed between \LB versions:

\begin{description}
 \item [\texttt{edg\_wlc\_JobId}] -- data structure used in WMS 3.1 and earlier
  \begin{itemize}
   \item header file -- \texttt{glite/lb/jobid.h}
   \item important funcions:
    \begin{itemize}
     \item \texttt{edg\_wlc\_JobIdParse} -- convert JobId in a form of
      string into \texttt{edg\_wlc\_JobId} structure; returns 0 for
      success and EINVAL if the input string can't be parsed into a valid JobId
     \item \texttt{edg\_wlc\_JobIdUnParse} -- produce the string
      representation of JobId structure
     \item \texttt{edg\_wlc\_JobIdFree} -- dealocation of the structure
    \end{itemize}
  \end{itemize} 
 \item [\texttt{glite\_jobid\_t}] -- new data structure for \LB 2.0 
  \begin{itemize}
   \item different header file -- \texttt{glite/jobid/cjobid.h}
   \item new names of important funcions described above:
    \begin{itemize}
     \item \texttt{glite\_jobid\_parse}
     \item \texttt{glite\_jobid\_unparse}
     \item \texttt{glite\_jobid\_free}
    \end{itemize}
  \end{itemize}
\end{description}

\subsection{Event}
Data structure \texttt{edg\_wll\_Event} represents a \LB event, atomic
data unit received and processed by \LB. It is a set of key--value
pairs with predefined structure -- allowed event types and names of
attributes. In \LB each event must be associated with a particular
job. The \texttt{edg\_wll\_Event} is returned by customer LB API job
event related calls. The data structure have a common part and a event
type specific part. Most important common event attributes:
\begin{itemize}
  \item \texttt{jobId} -- identificaion of the job the event belongs to.
  \item \texttt{user} -- identity (certificate subject) of the event sender.
  \item \texttt{timestamp} -- time when the event was generated.
  \item \texttt{seqcode} -- sequence code assigned to the event.
  \item \texttt{type} -- event type.
\end{itemize}

The event type is transparent. The only important operation defined is
\texttt{edg\_wll\_FreeEvent(edg\_wll\_Event *event)} to free event
structure. For more information see file \texttt{org.glite.lb.types/types.T} 

\TODO{example - Michal?}

\subsection{Job Status}
Data type \texttt{edg\_wll\_JobStat} represents status of a job as
computed by \LB from received events. The data structure have a common
part and a job state specific part. Most important common
attributes:
\begin{itemize}
  \item \texttt{state} -- numeric code of the status
    (EDG\_WLL\_JOB\_SUBMITTED, EDG\_WLL\_JOB\_WAITING, \dots)
  \item \texttt{type} -- type of the job (EDG\_WLL\_JOB\_SIMPLE,
    EDG\_WLL\_JOB\_DAG, EDG\_WLL\_JOB\_COLLECTION) 
  \item \texttt{children} -- list of subjob \jobid's
\end{itemize}



