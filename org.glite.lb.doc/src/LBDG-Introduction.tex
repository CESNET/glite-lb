% -*- mode: latex -*-

\section{\LB API introduction}
\input versions

\TODO{Udelat nejaky odkaz na UG - LB introduction and architecture}

The whole \LB service shares a number of common concepts and
principles used to design, develop and use the services. Most of
common data types and functions is separated in its own SW module called
\LB common.

\subsection{\LB API design notes}

\subsubsection{Context and Parameter Settings}
\label{s:context}

All the API functions refer to a~\emph{context} argument. See next
session for futher description of context type \verb'edg_wll_Context'.

Context objects preserve various status information
(\eg\ connection to server) among the API calls.
The API caller can create many context objects, those are guaranteed
to be independent on one another.
In this way thread-safety of the library is achieved --
one context object has to be used by only one thread at time.

Context is used to set and keep various parameters of the library
(\eg\ default server addresses, timeouts, \dots).
Upon initialization, all the parameters are assigned default values.
However, many of the parameters take their default value from environment
variables. If the corresponding environment variable is set,
the parameter is initialized to its value instead of the default.
Note that a~few parameters cannot be assigned default value; consequently
setting them either in environment or with an explicit API call
is mandatory before using the appropriate part of the API.

The context also stores details on errors of the recent API call.

For use with the \emph{producer} calls (see Sect.~\ref{s:producer})
the context has to be assigned a~single \jobid
(with the \verb'edg_wll_SetLoggingJob' call),
and keeps track of an event \emph{sequence code} for the job 
(see~\cite{LBUG}, detailed description in~\cite{lbarch}).

\subsubsection{Asynchronnous calls}
\LB library calls are typically asynchronnous. The typical call --
loging a event -- is returned immediatelly and the success of the call
means that the first \LB infrastructure component takes over the event
for delivery. The event itself is queued for delivery to the \LB
server, so there is no guarantee that subsequent query will see the
event. This is not true for new job registration. It is the operation done
synchronously.

The \LB proxy provides a \emph{local view} semantics. The \LB proxy
query semantics is synchronnous (there is a guarantee that a query
next to the event logging call will see the event) but only for events
logged through the particular \LB proxy instance.

\subsubsection{Connection pool}
For better performance the \LB client library have a feature called
connection pool -- a client--server connection is transparently reused
by different threads/context to eliminate the overhead of secure
channel establishment.

\subsubsection{Function arguments}
In the following description the function arguments are classified as follows:
\begin{description}
\item[IN] pure input argument, not modified by the function.
If it is a~pointer, the C prototype includes \verb'const' (which is omitted in
this document for the sake of readability).
\item[OUT] pure output argument. The function expects a~pointer and fills in
the pointed object.

If the argument is \verb'**', or a~structure containing pointers,
the returned objects are \emph{always} dynamically allocated,
and has to be freed when not used anymore.
The same holds for directly returned pointers.

\item[INOUT] an argument taken as an input and modified by the function.
Typically it is the \LB context.

\end{description}

\subsubsection{Datatypes}
The API uses two classes of custom datatypes:
\begin{description}
\item[opaque types] (\eg context, jobid) do not expose their structure
to the user.
The only way to access them is via the API functions.
The internal structure of those may be subject to change.

\item[transparent types] (\eg event, status) expose the structure to the
user. The structure is documented and no incompatible changes will be done
without notice.
\end{description}

\subsubsection{Return values}
The return type of most of the API functions is return \verb'int'.
Unless specified otherwise the returned values are as follows:
\begin{description}
\item[0] success
\item[errno] an error occured, the nature of the error
matches meaning of one of standard \verb'<errno.h>' error codes.
\item[\LB specific] a~few errors can't be intuitively mapped to
\verb'<errno.h>', therefore the are specific \LB error codes, starting from \verb'EDG_WLL_ERROR_BASE'.
\end{description}
See Sect.~\ref{s:error} for details on error handling.

Few API function return \verb'char *'. In such a~case \verb'NULL' indicates
an error, non-null value means success.

\subsection{\LB common general components}

\subsubsection{JobId} 
\TODO{JobId kratce vetveno na 3.1 a 2.0 (jmeno a umisteni / samostatny
  modul) Odkazy na zacatek user's guide pro vysvetleni architektury.}
The primary entity of \LB is a job, identified by JobId -- a unique
identifier of the job. The type representing the JobId is opaque, it's
contents is hidden to the API users and should be manipulated with the
access methods only. 

The JobId representing data structure name and location
changed between \LB versions:

\begin{itemize}
 \item \texttt{edg\_wlc\_JobId} -- old data structure used in WMS 3.1
  edg\_wlc\_JobIdParse, edg\_wlc\_JobIdFree
  glite/lb/jobid.h 
 \item \texttt{glite\_jobid\_t} -- new data structure for \LB 2.0 
  glite/jobid/cjobid.h
\end{itemize}

\subsubsection{edg\_wll\_Event}
Data structure \texttt{edg\_wll\_Event} represents a \LB event, atomic
data unit received and processed by \LB. It is a set of
key--value pairs with predefined structure -- allowed event types and
names of attributes. It is returned by customer LB API job event
related calls. The data structure have a common part and a event
type specific part. Most important common event attributes:
\begin{itemize}
  \item \texttt{jobId} Grid job id of the job the event belongs to.
  \item \texttt{user} Identity (certificate subject) of the event sender.
  \item \texttt{timestamp} Time when the event was generated.
  \item \texttt{seqcode} Sequence code assigned to the event.
  \item \texttt{type} Event type.
\end{itemize}

The event type is transparent. The only important operation defined is
\texttt{edg\_wll\_FreeEvent(edg\_wll\_Event *event)} to free event
structure. For more information see file \texttt{org.glite.lb.types/types.T} 

\TODO{example - Michal?}

\subsubsection{edg\_wll\_JobStat}
Data type \texttt{edg\_wll\_JobStat} represents status of a job as
computed by \LB from received events. The data structure have a common
part and a job state specific part. Most important common
attributes:
\begin{itemize}
  \item \texttt{state} numeric code of the status
    (EDG\_WLL\_JOB\_SUBMITTED, EDG\_WLL\_JOB\_WAITING, \dots)
  \item \texttt{type} type of the job (EDG\_WLL\_JOB\_SIMPLE,
    EDG\_WLL\_JOB\_DAG, EDG\_WLL\_JOB\_COLLECTION) 
  \item \texttt{children} list of subjob \jobid's
\end{itemize}


\subsubsection{edg\_wll\_Context} 
Data structure representing \LB API context (see
section~\ref{s:context}).  There are parameters described in consumer
and producer API chapters which are stored in context and accessed by
funcions described below (\texttt{edg\_wll\_SetParam}) using
appropriate constants. Examples of common context parameters:
\begin{itemize}
  \item \texttt{EDG\_WLL\_PARAM\_X509\_KEY} key file to use for authentication.
  \item \texttt{EDG\_WLL\_PARAM\_X509\_CERT} certificate file to use for
      authentication
\end{itemize}

The context type is opaque. Operations with the type instance:
\begin{itemize}
  \item \texttt{edg\_wll\_InitContext(edg\_wll\_Context *context)}
    Allocate and initialize a new context object.
  \item \texttt{edg\_wll\_FreeContext(edg\_wll\_Context context)}
    Destroy and free context object.
  \item \texttt{edg\_wll\_SetParam(edg\_wll\_Context context, 
    edg\_wll\_ContextParam param, val)} Set a context parameter.
  \item \texttt{edg\_wll\_GetParam(edg\_wll\_Context context, 
    edg\_wll\_ContextParam param, val)} Get current parameter value.
\end{itemize}
For more information see file \texttt{context.h} 

\TODO{Referenced or inline example?}

\subsubsection{\LB common header files}

Header files for mentioned common structures are summarized in the
following table, other important header files are described in the
next chapters (producer and consumer API).

\begin{table}[h]
\begin{tabularx}{\textwidth}{>{\tt}lX}
glite/lb/context.h & Definition of context structure and parameters. \\
glite/lb/events.h & \LB event data structure.\\
glite/lb/jobstat.h & Job status structure returned by consumer API.\\
\end{tabularx}
\end{table}


